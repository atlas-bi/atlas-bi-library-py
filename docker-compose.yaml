version: "3.9"

services:
  db:
    image: postgres:17
    expose:
      - "5432"
    ports:
      - "${POSTGRES_HOST_PORT:-5433}:5432"
    volumes:
      - turbo_pg_data:/var/lib/postgresql/data
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 2s
      timeout: 2s
      retries: 10
  dg_db:
    image: mcr.microsoft.com/mssql/server:2022-latest
    user: "0:0"
    command: >-
      bash -lc "
      chown -R 10001:0 /var/opt/mssql || true
      exec /opt/mssql/bin/sqlservr
      "
    expose:
      - "1433"
    ports:
      - "${DG_DB_HOST_PORT:-1434}:1433"
    volumes:
      - turbo_mssql_data:/var/opt/mssql
    environment:
      ACCEPT_EULA: "Y"
      MSSQL_SA_PASSWORD: ${DG_DB_PASSWORD:-StrongPassword!123}
      MSSQL_PID: ${MSSQL_PID:-Evaluation}
  api:
    command: |-
      bash -lc "
      set -e

      /.venv/bin/python - <<'PY'
      import os
      import time

      import pyodbc

      host = os.environ.get('DG_DB_HOST', 'dg_db')
      port = os.environ.get('DG_DB_PORT', '1433')
      user = os.environ.get('DG_DB_USER', 'sa')
      pw = os.environ.get('DG_DB_PASSWORD', '')
      db = os.environ.get('DG_DB_NAME', 'atlas')
      driver = os.environ.get('SQLSERVER_DRIVER', 'ODBC Driver 18 for SQL Server')
      extra = os.environ.get(
          'SQLSERVER_EXTRA_PARAMS',
          'Encrypt=yes;TrustServerCertificate=yes',
      )

      dsn = f\"DRIVER={{{driver}}};SERVER={host},{port};UID={user};PWD={pw};DATABASE=master;{extra}\"
      last = None
      for _ in range(60):
          try:
              cn = pyodbc.connect(dsn, timeout=5)
              cn.autocommit = True
              cur = cn.cursor()
              cur.execute(
                  \"IF DB_ID(?) IS NULL EXEC('CREATE DATABASE [' + REPLACE(?,']',']]') + ']')\",
                  db,
                  db,
              )
              cur.close()
              cn.close()
              break
          except Exception as e:
              last = e
              time.sleep(2)
      else:
          raise SystemExit(f'Failed waiting for SQL Server / creating DB: {last}')
      PY

      /.venv/bin/python manage.py migrate
      /.venv/bin/python manage.py migrate --database=dg_db
      /.venv/bin/python manage.py seed_dg_db
      /.venv/bin/python manage.py runserver 0.0.0.0:8000
      "
    build:
      context: .
      dockerfile: Dockerfile
      target: api
    working_dir: /app
    expose:
      - "8000"
    ports:
      - "${API_HOST_PORT:-8000}:8000"
    environment:
      DEBUG: ${DEBUG}
      SECRET_KEY: ${SECRET_KEY}
      DB_MODE: ${DB_MODE:-dual}
      DEFAULT_DB_VENDOR: ${DEFAULT_DB_VENDOR:-postgres}
      DATABASE_USER: ${DATABASE_USER:-postgres}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD:-${POSTGRES_PASSWORD}}
      DATABASE_NAME: ${DATABASE_NAME:-${POSTGRES_DB:-atlas}}
      DATABASE_HOST: db
      DATABASE_PORT: ${DATABASE_PORT:-5432}
      DATABASE_TEST_NAME: ${DATABASE_TEST_NAME}
      SQLSERVER_DRIVER: ${SQLSERVER_DRIVER}
      SQLSERVER_EXTRA_PARAMS: ${SQLSERVER_EXTRA_PARAMS}
      DG_DB_VENDOR: ${DG_DB_VENDOR:-mssql}
      DG_DB_USER: ${DG_DB_USER:-sa}
      DG_DB_PASSWORD: ${DG_DB_PASSWORD:-StrongPassword!123}
      DG_DB_NAME: ${DG_DB_NAME:-atlas}
      DG_DB_HOST: ${DG_DB_HOST:-dg_db}
      DG_DB_PORT: ${DG_DB_PORT:-1433}
      DG_DB_APP_LABELS: ${DG_DB_APP_LABELS:-atlas_index}
    depends_on:
      db:
        condition: service_healthy
      dg_db:
        condition: service_started
  web:
    command: bash -c "pnpm --filter web start -p 3000"
    build:
      context: .
      dockerfile: Dockerfile
      target: web
    working_dir: /app
    expose:
      - "3000"
    ports:
      - "${WEB_HOST_PORT:-3001}:3000"
    environment:
      API_URL: ${API_URL}
      NEXTAUTH_URL: ${NEXTAUTH_URL}
      NEXTAUTH_SECRET: ${NEXTAUTH_SECRET}
    depends_on:
      - api

volumes:
  turbo_pg_data:
  turbo_mssql_data:
